---
title: 主从复制和哨兵模式
categories: Redis
tags:
  - Redis
excerpt: ''
cover: https://pic.sucaibar.com/pic/201701/18/1141004892.jpg
---

### Redis主从复制

主从复制，读写分离！80%的情况下都是进行读操作！，只需要将读的压力给到从机，主机只负责写。减缓服务器的压力。

**概念**

主从复制，是将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master/leader)，后者称为从节点(slave/follower)；数据的复制时单向的，只能由主节点到从节点，Master以写为主，Slave以读为主。

***默认情况下，每台Redis服务器都是主节点；***

***且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。***



**主从复制的作用：**

- 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。

- 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余

- 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务(即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点)，分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。

- 高可用(集群)基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。

一般来说，要将Redis运用到项目中，只是用一台Redis是万万不能的，原因如下

- 从结构上，单个Redis服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大
- 从容量上，单个Redis服务器内存容量有限，就算一台Redis服务器内存容量为256G，也不能将所有内存用于Redis存储内容，一般来说单台Redis最大使用内存不应该超过20G.



### 环境配置(只需要配置从库，默认是主库)

~~~bash
127.0.0.1:6379> info replication # 查看当前库的信息
# Replication
role:master #角色
connected_slaves:0 #连接从机数量
master_failover_state:no-failover
master_replid:626f7ecc1987d31feb9e25a761b65b74b603d180
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
~~~

复制三个配置文件，然后修改对应的信息

- 端口(port 6379)
- pid名字(pidfile /var/run/redis_6379.pid)
- log文件名字(logfile "")
- dump.rdb名字(dbfilename dump.rdb)

修改完成，启动服务

一主二从：默认情况下，每台服务器都是主节点；所以一般默认配置从机就可以



~~~bash
127.0.0.1:6380> SLAVEOF 127.0.0.1 6379 #连接主机，需要把密码去掉/或者在从机配置文件中加上masterauth ""
127.0.0.1:6380> set k1 v1 # 主机才能写，从机不能写
(error) READONLY You can't write against a read only replica.

~~~

测试：主机断开连接，从机依旧连接到主机的，但是没有写操作，这个时候主机如果回来了，从机依旧可以直接获取到从机写的信息！

如果是使用命令行，来配置的主从，如果重启了从机，就会变回主机！只要变为从机，立马就会从主机中获取值。

> 复制原理

Slave启动成功连接到master后会发送一个sync同步命令

Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master将传送整个数据文件到slave，并在一次完全同步。

全量复制：而slave服务在接受到数据库文件数据后，将其存盘并加载到内存中。

增量复制：Master继续将新的所有收集到的修改命令依次传给slave，完成同步。

但是只要是重新连接master，一次完全同步(全量复制)将被自动执行！数据一定可以在从机中看到！



> 层层链路

中间的既是主机也是从机，还是不能执行写操作

~~~bash
127.0.0.1:6380> SLAVEOF no one # 如果主机断开了连接，可以使用slave no one 让自己变为主机！其他的节点就可以手动连接到最新的这个主节点(手动)！如果这个时候原来的主机修复了，那就重新连接(slaveof ip 端口号)
~~~



### 哨兵模式(自动选取主机方式)

如果Master节点断开了，这个时候就会从从机中随机选择一个服务器 ! (投票算法)

如果主机回来了，只能归并到新的主机下，当作从机。



> 概述

主从切换技术的方法是：当主服务器宕机后，需要手动把一台服务器切换为主服务器，这就需要人工干预，费时费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式，Redis从2.8开始正式提供了Sentinel(哨兵) 架构来解决这个问题。

能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库。

哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，他会独立运行，其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例

哨兵通常设置多个

假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover(重新选举)过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象称为主观下线。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover[故障转移]操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为客观下线。

优点：

- 哨兵集群，基于主从复制模式，所有的主从配置优点，它都有

- 主从可以切换，故障可以转移，系统的可用性就会更好
- 哨兵模式就是主从模式的升级，手动到自动，更加健壮

缺点：

- Redis不好在线扩容，集群数量一旦达到上限，在线扩容就十分麻烦
- 实现哨兵模式的配置其实是很麻烦的，里面有很多选择



> 测试

- 配置哨兵配置文件 sentinel.conf

~~~bash
sentinel monitor myredis(随便写) 127.0.0.1 6379 1
#sentinel monitor 被监控的名称 host port 1
#后面这个1 代表主机挂了，slave投票看让谁接替成为主机，票数最多的，就会成为主机！
~~~

- 启动哨兵

  redis-sentinel zconfig/sentinel.conf