---
title: Redis缓存穿透和雪崩
categories: Redis
tags:
  - Redis
excerpt: ''
cover: https://www.liuwo.com/wp-content/uploads/2021/01/1609769565-1679091c5a880fa.jpg
---

### Redis缓存穿透和雪崩

> 简介

Redis缓存的使用，极大提升了应用程序的性能和效率，特别时数据查询方面。但同时，它也带来了一些问题。其中最要害的问题，就是数据的一致性问题，从严格意义上来讲，这个问题无解。如果对数据的一致性要求很高，那么就不能使用缓存。

另外的一些典型问题就是，缓存雪崩和缓存击穿。

## 缓存穿透

> 概念

缓存穿透的概念很简单，用户想要查询一个数据，发现redis内存数据库没有，也就是缓存没有命中，于是像持久层数据库查询，发现也没有，于是查询失败。当用户很多的时候，缓存没有命中，于是都去请求了持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当与出现了缓存穿透。

> 解决方法

#### 布隆过滤器

布隆过滤器是一种数据结构，对所有可能查询的参数以hash形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储数据系统的查询压力

#### 缓存空对象

当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据将从缓存中获取，保护了后端数据库。

但这种方法会存在两个问题：

- 如果空值能够被缓存起来，这就意味这缓存需要更多的空间存储更多的键，因为这当中可能有许多空值的键
- 即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致，这对需要保持一致性的业务会有影响。

## 缓存击穿

> 概念

这里需要蓄意与缓存穿透的区别，是指一个key非常热点，在不停的扛着大并发，大并发集中对这一点访问，当这个key在失效的瞬间，持续的大并发就会穿破缓存，直接请求数据库。

当某个key过期的瞬间，有大量的请求并发访问，这类数据一般是热点数据，由于缓存过期，会同时访问数据库来查询最新数据，并且回写缓存哦，会使数据库瞬间压力过大。

> 解决方案

##### 设置热点数据永不过期

从缓存层面来看，没有设置过期时间，所有不会出现热点key过期后产生的问题。

##### 加互斥锁

分布式锁：使用分布式锁，保证对于每个key同时只有一个线程去查询后端访问，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。

## 缓存雪崩

> 概念

缓存雪崩，是指在一个时间段，缓存集中过期失效。

产生雪崩的原因之一，比如在一些数据放入缓存中一个小时，在这些缓存过期的时候，对这件数据的查询都落到数据库上，对于数据库而言，就会产生周期性的压力波峰，于是所有的请求都会达到存储层，存储层的调用量会暴增，造成存储层挂掉的情况。

其实集中过期倒不是非常致命，比较致命的缓存雪崩，是缓存服务器某个节点宕机或断网。因为自然形成的雪崩，一定是某个时间段集中创建缓存，这个时候，数据库也是可以顶住压力的。无非就是对数据库产生周期性的压力而已，而缓存服务器节点宕机，对数据库服务器造成的压力是不可预知的，也有可能瞬间就把数据库压垮。

> 解决方案

##### redis高可用

这个思想的含义是，既然redis有可能挂掉，那我就多增设几台redis，这样一台挂掉之后其他的还可以继续工作，其实就是搭建的集群。（异地多活）

##### 限流降级

这个解决方案的思想是，在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如某个key只允许一个线程查询和写缓存，其他线程等待。

##### 数据预热

数据加热的含义就是正式部署之前，先把可能的数据预先访问一边，这样部分可能大量访问的数据就会加载到缓存中。即在发生大并发访问前手动触发加载缓存不同的key，设置不同的过期时间，让缓存失效的时间尽量均匀。